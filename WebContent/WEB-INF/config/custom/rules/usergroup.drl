package USERGROUP_RuleSet
expander usergroup.dsl

import com.idsscheer.webapps.arcm.bl.re.ext.CollectiveHelper;
import com.idsscheer.webapps.arcm.bl.re.ext.CollectiveHelperBB;
import com.idsscheer.webapps.arcm.bl.component.administration.re.UsergroupHelper;

# OBJECT    client_objid       LONG       Client ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
# OBJECT    client_sign        CLIENTSIGN Client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# OBJECT    create_date        DATE       Creation date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# OBJECT    creator_user_id    LONG       User ID (creator)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# OBJECT    delete_date        DATE       Deletion date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# OBJECT    guid               STRING     GUID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# OBJECT    obj_id             LONG       ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# OBJECT    obj_type           OBJECTTYPE Object type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# OBJECT    root_guid          STRING     Root GUID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
# OBJECT    versions           LONG       Number of versions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# VERSION   aris_change_date   DATE       ARIS change date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# VERSION   change_date        DATE       Change date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# VERSION   change_type        ENUM       Change type          changetype (created=0,unchanged=1,changed=2,deleted=3,xmlcreated=4,xmlchanged=5,xmldeleted=6)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# VERSION   change_user_id     LONG       User ID (editor)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# VERSION   deactivated        BOOLEAN    Deactivated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# VERSION   id                 LONG       ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# VERSION   substitute_user_id LONG       User ID (substitute)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# VERSION   version_active     BOOLEAN    Current version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# VERSION   version_number     LONG       Version number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
# USERGROUP description        TEXT       Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# USERGROUP groupmembers       LIST       Users                to * USERs (LT=1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# USERGROUP name               STRING     Name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# USERGROUP role               ENUM       Role                 userrole_type (all=-1,please_select=0,none=-2,auditowner=auditowner,auditreviewer=auditreviewer,auditstepowner=auditstepowner,auditauditor=auditauditor,auditmanager=auditmanager,deficiencyauditor_l1=deficiencyauditor_l1,deficiencyauditor_l2=deficiencyauditor_l2,deficiencyauditor_l3=deficiencyauditor_l3,clientadmin=clientadmin,controlmanager=controlmanager,deficiencymanager_l1=deficiencymanager_l1,deficiencymanager_l2=deficiencymanager_l2,deficiencymanager_l3=deficiencymanager_l3,groupusermanager=groupusermanager,hierarchyauditor=hierarchyauditor,hierarchymanager=hierarchymanager,hierarchyowner=hierarchyowner,incidentmanager=incidentmanager,incidentowner=incidentowner,incidentreviewer=incidentreviewer,incidentauditor=incidentauditor,lossmanager=lossmanager,lossowner=lossowner,lossreviewer=lossreviewer,lossauditor=lossauditor,issuemanager=issuemanager,issueauditor=issueauditor,policyowner=policyowner,policyapprover=policyapprover,policyaddressee=policyaddressee,policyauditor=policyauditor,policymanager=policymanager,riskauditor=riskauditor,riskmanager=riskmanager,riskowner=riskowner,riskreviewer=riskreviewer,signoffmanager=signoffmanager,signoffowner=signoffowner,signoffreviewer=signoffreviewer,surveymanager=surveymanager,questionnaireowner=questionnaireowner,surveyreviewer=surveyreviewer,surveyauditor=surveyauditor,sysadmin=sysadmin,testauditor=testauditor,testauditorexternal=testauditorexternal,tester=tester,testmanager=testmanager,testreviewer=testreviewer)
# USERGROUP rolelevel          ENUM       Role level           userrole_level (all=-1,please_select=0,crossclient=X,client=C,object=O)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   

# DO NOT CHANGE THE LINES ABOVE - all of them will be updated automatically by tool com.idsscheer.webapps.arcm.bl.re.RETemplater

################################################
### All workflow states - before state rules ###

rule "define all standard attributes editable [I,V]"

    salience 10500
	no-loop true

	when
		user is service user
	then
		set "client_sign"   		editable
		set "name"          		editable
		set "description"   		editable
		set "role"          		editable
		set "rolelevel"     		editable
		set "groupmembers"  		editable
		
		########################
		### BB CUSTOMIZATION ###
		set "bb_orgunit" 			editable

end

rule "mark_mandatory_fields_[I,V]"

	salience 10400
	no-loop true

	when
		user is service user
	then
		set "client_sign" mandatory
		set "name"        mandatory
		set "role"        mandatory
		set "rolelevel"   mandatory

end

rule "group already saved --> client sign read only [I,V]"
	
	salience 10300
	no-loop true 
	
	when
		object is_not new
		user is service user
		
	then
	    set "client_sign" not_mandatory
		set "client_sign" readonly

end

rule "client sign not filled  --> role and rolelevel NOT editable [I,V]"

	salience 10200
	no-loop true

	when
		"client_sign" is_not filled

	then
		set "rolelevel" readonly
		set "role"      readonly

end


rule "group already saved, assigned to any other appobj or is predefined system admin group --> role and rolelevel NOT editable [I,V]"
	
	salience 10200
	no-loop true 
	
	when
		object is_not new
		( usergroup already assigned OR
		  usergroup is predefined system admin group )
		user is_not service user
		
	then
		set "rolelevel" readonly
		set "role"      readonly

end

# if deletion of associated users at a system administrator usergroup means that thereafter there will be no 
# more users associated to some system administrator group, then suppress deletion of this children. 
rule "ensure there is at least one system administrator [V]"

	salience 10100
	no-loop true
	
	when
		usergroup is system admin group
		there are no more system administrators inside this group
		there are no more system administrators out of this group
		user is service user
		
	then
		set "groupmembers" invalid
		add object "error" message "error.delete.last.systemadmin.ERR"
				
end

#
# for usergroups we check the uniqueness explicitly
#
rule "prevent unique key violation [V]"
	
	salience 10000
	no-loop true 
	
	when
		"client_sign" is filled
		"name" is filled
		( "client_sign" is dirty OR
		  "name" is dirty )
		#uses attribute values "client_sign" and "name" for check
		usergroup is_not unique 
		
	then
		set "name" invalid
		add "error" message "error.usergroup.exists" to "name"

end

rule "inform if license component is missing [I,V]"

	salience 10100
	no-loop true

	when
        object is_not licensed

	then
		add object "error" message "umc.usergroup.licensed.components.missing.ERR"
		set "rolelevel" readonly
        set "role"      readonly

end
