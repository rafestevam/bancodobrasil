package CLIENT_RuleSet
expander client.dsl

import com.idsscheer.webapps.arcm.bl.re.ext.CollectiveHelper;
import com.idsscheer.webapps.arcm.bl.component.administration.re.ClientHelper;

# OBJECT  client_objid               LONG       Client ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# OBJECT  client_sign                CLIENTSIGN Client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# OBJECT  create_date                DATE       Creation date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# OBJECT  creator_user_id            LONG       User ID (creator)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# OBJECT  delete_date                DATE       Deletion date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# OBJECT  guid                       STRING     GUID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
# OBJECT  obj_id                     LONG       ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# OBJECT  obj_type                   OBJECTTYPE Object type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# OBJECT  root_guid                  STRING     Root GUID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# OBJECT  versions                   LONG       Number of versions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# VERSION aris_change_date           DATE       ARIS change date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# VERSION change_date                DATE       Change date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# VERSION change_type                ENUM       Change type                                                    changetype (created=0,unchanged=1,changed=2,deleted=3,xmlcreated=4,xmlchanged=5,xmldeleted=6)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# VERSION change_user_id             LONG       User ID (editor)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# VERSION deactivated                BOOLEAN    Deactivated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# VERSION id                         LONG       ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# VERSION substitute_user_id         LONG       User ID (substitute)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
# VERSION version_active             BOOLEAN    Current version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
# VERSION version_number             LONG       Version number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# CLIENT  businessyearstartdate      DATE       Start date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
# CLIENT  components                 ENUM       Active components                                              licensedcomponent (audit_management=am,deficiency_management=dm,issue_management=im,loss_management=il,incident_management=in,policy_management=pm,risk_management=rm,signoff_management=so,survey_management=sm,test_management=tm,change_management=cm)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# CLIENT  connecturl                 STRING     URL to the connect server
# CLIENT  default_currency           ENUM       Currency (default)                                             currency (please_select=0,MIXED=-99,common=-1,AUD=8,CAD=26,CNY=30,EUR=47,GBP=50,JPY=74,USD=155,others=-2,AED=1,AFA=2,AFN=971,ALL=3,AMD=4,ANG=5,AOA=6,ARS=7,AWG=9,AZM=10,BAM=11,BBD=12,BDT=13,BGN=14,BHD=15,BIF=16,BMD=17,BND=18,BOB=19,BRL=20,BSD=21,BTN=22,BWP=23,BYR=24,BZD=25,CDF=27,CHF=28,CLP=29,COP=31,CRC=32,CSD=33,CUC=34,CUP=35,CVE=36,CYP=37,CZK=38,DJF=39,DKK=40,DOP=41,DZD=42,EEK=43,EGP=44,ERN=45,ETB=46,FJD=48,FKP=49,GEL=51,GGP=52,GHC=53,GIP=54,GMD=55,GNF=56,GTQ=57,GYD=58,HKD=59,HNL=60,HRK=61,HTG=62,HUF=63,IDR=64,ILS=65,IMP=66,INR=67,IQD=68,IRR=69,ISK=70,JEP=71,JMD=72,JOD=73,KES=75,KGS=76,KHR=77,KMF=78,KPW=79,KRW=80,KWD=81,KYD=82,KZT=83,LAK=84,LBP=85,LKR=86,LRD=87,LSL=88,LTL=89,LVL=90,LYD=91,MAD=92,MDL=93,MGA=94,MKD=95,MMK=96,MNT=97,MOP=98,MRO=99,MTL=100,MUR=101,MVR=102,MWK=103,MXN=104,MYR=105,MZM=106,MZN=943,NAD=107,NGN=108,NIO=109,NOK=110,NPR=111,NZD=112,OMR=113,PAB=114,PEN=115,PGK=116,PHP=117,PKR=118,PLN=119,PYG=120,QAR=121,ROL=122,RON=946,RSD=941,RUB=123,RWF=124,SAR=125,SBD=126,SCR=127,SDD=128,SDG=938,SEK=129,SGD=130,SHP=131,SIT=132,SKK=133,SLL=134,SOS=135,SPL=136,SRD=137,STD=138,SVC=139,SYP=140,SZL=141,THB=142,TJS=143,TMM=144,TND=145,TOP=146,TRL=147,TRY=148,TTD=149,TVD=150,TWD=151,TZS=152,UAH=153,UGX=154,UYU=156,UZS=157,VEB=158,VEF=937,VND=159,VUV=160,WST=161,XAF=162,XAG=163,XAU=164,XCD=165,XDR=166,XOF=167,XPD=168,XPF=169,XPT=170,YER=171,ZAR=172,ZMK=173,ZWD=174)
# CLIENT  description                TEXT       Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# CLIENT  email                      STRING     E-mail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  impacttypes                LIST       Impact types                                                   to * IMPACTTYPEs (LT=5820)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# CLIENT  includeSiteImpactTypes     BOOLEAN    Include system impact types                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# CLIENT  isconnectactive            BOOLEAN    is connect active
# CLIENT  ispublisheractive          BOOLEAN    is publisher active
# CLIENT  language                   ENUM       Language                                                       language (all=-1,please_select=0,german=de,english=en,french=fr,japanese=ja,chinese=zh,spanish=es,portuguese=pt,italian=it,russian=ru,hungarian=hu)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# CLIENT  linktypes                  LIST       Link types                                                     to * DOCUMENTLINKTYPEs (LT=3115)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
# CLIENT  lowerlimit_exploss_avg     DOUBLE     Risk matrix lower limit of the expected loss (average)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  lowerlimit_exploss_max     DOUBLE     Risk matrix lower limit of the expected loss (maximum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  lowerlimit_exploss_min     DOUBLE     Risk matrix lower limit of the expected loss (minimum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  lowerlimit_redexploss_avg  DOUBLE     Risk matrix lower limit of the reduced expected loss (average)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# CLIENT  lowerlimit_redexploss_max  DOUBLE     Risk matrix lower limit of the reduced expected loss (maximum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# CLIENT  lowerlimit_redexploss_min  DOUBLE     Risk matrix lower limit of the reduced expected loss (minimum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# CLIENT  modellinkpattern           STRING     Model link                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
# CLIENT  name                       STRING     Name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
# CLIENT  notification_to            ENUM       Notification to                                                assessment_notification (object_specific_riskmanager=1,client_specific_riskmanager=2,cross_client_riskmanager=3,no_notification=4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# CLIENT  objectlinkpattern          STRING     Object link                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# SITE    publisheddatabase          STRING     Published database to work on
# SITE    tenant                     STRING     Tenant to work on
# CLIENT  sessiontime                LONG       Session time
# CLIENT  sign                       STRING     Client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  th_exp_avg_loss            DOUBLE     Threshold of the expected loss (average)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# CLIENT  th_exp_max_loss            DOUBLE     Threshold of the expected loss (maximum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# CLIENT  th_exp_min_loss            DOUBLE     Threshold of the expected loss (minimum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# CLIENT  th_red_exp_avg_loss        DOUBLE     Threshold of the reduced expected loss (average)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# CLIENT  th_red_exp_max_loss        DOUBLE     Threshold of the reduced expected loss (maximum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# CLIENT  th_red_exp_min_loss        DOUBLE     Threshold of the reduced expected loss (minimum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# CLIENT  upperlimit_exploss_avg     DOUBLE     Risk matrix upper limit of the expected loss (average)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  upperlimit_exploss_max     DOUBLE     Risk matrix upper limit of the expected loss (maximum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  upperlimit_exploss_min     DOUBLE     Risk matrix upper limit of the expected loss (minimum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# CLIENT  upperlimit_redexp_loss_max DOUBLE     Risk matrix upper limit of the reduced expected loss (maximum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# CLIENT  upperlimit_redexploss_avg  DOUBLE     Risk matrix upper limit of the reduced expected loss (average)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# CLIENT  upperlimit_redexploss_min  DOUBLE     Risk matrix upper limit of the reduced expected loss (minimum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

# DO NOT CHANGE THE LINES ABOVE - all of them will be updated automatically by tool com.idsscheer.webapps.arcm.bl.re.RETemplater

################################################
### All workflow states - before state rules ###

rule "define all standard attributes editable [I,V]"

    salience 11500
    no-loop true

	when

	then
		set "name"                       editable
		set "email"                      editable
		set "language"                   editable
		set "description"                editable
		set "components"                 editable
		set "businessyearstartdate"      editable

		set "linktypes"                  editable
		set "default_currency"           editable

		set "ispublisheractive"          editable
		set "modellinkpattern"           editable
        set "objectlinkpattern"          editable

		set "isconnectactive"            editable
		set "publisheddatabase"          editable
		set "tenant"                     editable

		set "th_exp_min_loss"            editable
		set "th_exp_avg_loss"            editable
		set "th_exp_max_loss"            editable
		set "th_red_exp_min_loss"        editable
		set "th_red_exp_avg_loss"        editable
		set "th_red_exp_max_loss"        editable
		set "notification_to"            editable

		set "lowerlimit_exploss_min"     editable
		set "lowerlimit_exploss_avg"     editable
		set "lowerlimit_exploss_max"     editable
		set "lowerlimit_redexploss_min"  editable
		set "lowerlimit_redexploss_avg"  editable
		set "lowerlimit_redexploss_max"  editable
		set "upperlimit_exploss_min"     editable
		set "upperlimit_exploss_avg"     editable
		set "upperlimit_exploss_max"     editable
		set "upperlimit_redexploss_min"  editable
		set "upperlimit_redexploss_avg"  editable
		set "upperlimit_redexp_loss_max" editable
		set "includeSiteImpactTypes"     editable
		set "impacttypes"                editable

end

rule "protect impact types from being edited as long as client is not persistent yet [I,V]"

	salience 11400
	no-loop true

	when
		object is new

	then
		set "includeSiteImpactTypes" readonly
		set "impacttypes" readonly
		add object "information" message "client.deny.assigning.impacttypes.DBI"

end

rule "define publisher attributes editable [I,V]"

        salience 11300
    	no-loop true

    	when
            value comparison fulfilled: ":transient:" attr_value "ispublisheractive" "EQUALS" value "false"

    	then
            set "modellinkpattern"           invisible
            set "objectlinkpattern"          invisible

end

rule "define publisher mandatory attributes editable [I,V]"

        salience 11200
    	no-loop true

    	when
            value comparison fulfilled: ":transient:" attr_value "ispublisheractive" "EQUALS" value "true"

    	then
            set "modellinkpattern"           mandatory
            set "objectlinkpattern"          mandatory

end

rule "define connect attributes editable [I,V]"

        salience 11100
    	no-loop true

    	when
            NOT (is connect active)

    	then
            set "publisheddatabase"          invisible
            set "tenant"                     invisible

end

rule "define connect mandatory attributes editable [I,V]"

        salience 11100
    	no-loop true

    	when
            is connect active

    	then
            set "publisheddatabase"          editable
            set "tenant"                     editable

end

rule "mark_mandatory_fields [I,V]"

	salience 10900
	no-loop true

	when

	then
		set "name"                  mandatory
		set "email"                 mandatory
		set "language"              mandatory
		set "businessyearstartdate" mandatory
		set "components"            mandatory

end

rule "sign_writeable_and_mandatory_[I,V]"

	salience 10800
	no-loop true

	when
		object is new

	then
		set "sign"  editable
		set "sign"  mandatory

end

#
# for clients which use risk management:
# if client does not inherit impact types then it must assigned its own impact types
#
rule "no inheritance - impact types mandatory [V]"

    salience 10700
    no-loop true

	when
        value comparison fulfilled: ":transient:" attr_value "components" "CONTAINS" value "risk_management"
        value comparison fulfilled: ":transient:" attr_value "includeSiteImpactTypes" "EQUALS" value "false"

	then
        set "impacttypes" mandatory

end

#
# for clients which use risk management:
# if client does not inherit impact types then it must assigned its own impact types
#
rule "inheritance but no system impact types - impact types mandatory [V]"

    salience 10600
    no-loop true

	when
	    value comparison fulfilled: ":transient:" attr_value "components" "CONTAINS" value "risk_management"
        value comparison fulfilled: ":transient:" attr_value "includeSiteImpactTypes" "EQUALS" value "true"
        gets no impact types from site

	then
        set "impacttypes" mandatory

end

#
# amount without currency => invalid
# currency without amount => valid (unspecified)
#
rule "currency check [V]"

    salience 10500
    no-loop true

	when

	then
		check foreign amount "th_exp_avg_loss"            "default_currency"
		check foreign amount "th_exp_max_loss"            "default_currency"
		check foreign amount "th_exp_min_loss"            "default_currency"
		check foreign amount "th_red_exp_avg_loss"        "default_currency"
		check foreign amount "th_red_exp_max_loss"        "default_currency"
		check foreign amount "th_red_exp_min_loss"        "default_currency"
		check foreign amount "lowerlimit_exploss_min"     "default_currency"
		check foreign amount "upperlimit_exploss_min"     "default_currency"
		check foreign amount "lowerlimit_exploss_avg"     "default_currency"
		check foreign amount "upperlimit_exploss_avg"     "default_currency"
		check foreign amount "lowerlimit_exploss_max"     "default_currency"
		check foreign amount "upperlimit_exploss_max"     "default_currency"
		check foreign amount "lowerlimit_redexploss_min"  "default_currency"
		check foreign amount "upperlimit_redexploss_min"  "default_currency"
		check foreign amount "lowerlimit_redexploss_avg"  "default_currency"
		check foreign amount "upperlimit_redexploss_avg"  "default_currency"
		check foreign amount "lowerlimit_redexploss_max"  "default_currency"
		check foreign amount "upperlimit_redexp_loss_max" "default_currency"
		
end		

#
# 0 < risk matrix limit lower < risk matrix limit upper 
#
rule "check limits [V]"

    salience 10400
    no-loop true

	when

	then
		check limits "lowerlimit_exploss_min"    "upperlimit_exploss_min"
		check limits "lowerlimit_exploss_avg"    "upperlimit_exploss_avg"
		check limits "lowerlimit_exploss_max"    "upperlimit_exploss_max"
		check limits "lowerlimit_redexploss_min" "upperlimit_redexploss_min"
		check limits "lowerlimit_redexploss_avg" "upperlimit_redexploss_avg"
		check limits "lowerlimit_redexploss_max" "upperlimit_redexp_loss_max"
		
end		

#
# all thresholds >= 0 
#
rule "check thresholds [V]"

    salience 10300
    no-loop true

	when

	then
		check thresholds "th_exp_min_loss"     "th_exp_avg_loss"     "th_exp_max_loss"
		check thresholds "th_red_exp_min_loss" "th_red_exp_avg_loss" "th_red_exp_max_loss"

end

#
# for clients which use risk management:
# if client does not inherit impact types then it must assigned its own impact types
#
rule "no inheritance - check client impact types [V]"

    salience 10200
    no-loop true

	when
	    value comparison fulfilled: ":transient:" attr_value "components" "CONTAINS" value "risk_management"
	    "impacttypes" is_not filled
        value comparison fulfilled: ":transient:" attr_value "includeSiteImpactTypes" "EQUALS" value "false"

	then
        set "impacttypes" invalid
        add "information" message "client.has.no.own.impact.types.INF" to "impacttypes"

end

#
# for clients which use risk management:
# if client does not inherit impact types then it must assigned its own impact types
#
rule "inheritance - check site impact types [V]"

    salience 10100
    no-loop true

	when
	    value comparison fulfilled: ":transient:" attr_value "components" "CONTAINS" value "risk_management"
	    "impacttypes" is_not filled
        value comparison fulfilled: ":transient:" attr_value "includeSiteImpactTypes" "EQUALS" value "true"
        gets no impact types from site

	then
        set "impacttypes" invalid
        add "information" message "client.has.neither.own.nor.system.impact.types.INF" to "impacttypes"

end

#
# adding impact types to non-persistent clients will fail -> prevent this
#
rule "protect impacttypes from being edited as long as client is not persistent yet [I,V]"

	salience 10000
    no-loop true

	when
		object is new

	then
		set "impacttypes" readonly

end
########################
### BB CUSTOMIZATION ###
rule "mark client info readyonly [I,V]"

	salience 10800
	no-loop true
	
	when 	        
	     user has in_general role "riskparamadmin"

	then
		set "name"                       readonly
		set "email"                      readonly
		set "language"                   readonly
		set "description"                readonly
		set "components"                 readonly
		set "businessyearstartdate"      readonly
		set "linktypes"                  readonly
		set "default_currency"           readonly
		set "ispublisheractive"          readonly
end

rule "mark risk paramenters readyonly [I,V]"

	salience 10700
	no-loop true
	
	when 	        
	     (user has in_general role "sysadmin" OR 
	     user has in_general role "clientadmin")

	then
		set "th_exp_min_loss"            readonly
		set "th_exp_avg_loss"            readonly
		set "th_exp_max_loss"            readonly
		set "th_red_exp_min_loss"        readonly
		set "th_red_exp_avg_loss"        readonly
		set "th_red_exp_max_loss"        readonly
		set "notification_to"            readonly
		set "lowerlimit_exploss_min"     readonly
		set "lowerlimit_exploss_avg"     readonly
		set "lowerlimit_exploss_max"     readonly
		set "lowerlimit_redexploss_min"  readonly
		set "lowerlimit_redexploss_avg"  readonly
		set "lowerlimit_redexploss_max"  readonly
		set "upperlimit_exploss_min"     readonly
		set "upperlimit_exploss_avg"     readonly
		set "upperlimit_exploss_max"     readonly
		set "upperlimit_redexploss_min"  readonly
		set "upperlimit_redexploss_avg"  readonly
		set "upperlimit_redexp_loss_max" readonly
		set "includeSiteImpactTypes"     readonly
		set "impacttypes"                readonly
end