package LOSS_RuleSet
expander loss.dsl

import com.idsscheer.webapps.arcm.bl.re.ext.CollectiveHelper;
import com.idsscheer.webapps.arcm.bl.component.lossmanagement.re.LossHelper;
import com.idsscheer.webapps.arcm.bl.component.lossmanagement.re.LossHelperBB;

# OBJECT        client_objid             LONG       Client ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
# OBJECT        client_sign              CLIENTSIGN Client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# OBJECT        create_date              DATE       Creation date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# OBJECT        creator_user_id          LONG       User ID (creator)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# OBJECT        delete_date              DATE       Deletion date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# OBJECT        guid                     STRING     GUID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
# OBJECT        obj_id                   LONG       ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# OBJECT        obj_type                 OBJECTTYPE Object type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# OBJECT        root_guid                STRING     Root GUID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
# OBJECT        versions                 LONG       Number of versions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# VERSION       aris_change_date         DATE       ARIS change date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# VERSION       change_date              DATE       Change date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# VERSION       change_type              ENUM       Change type                                         changetype (created=0,unchanged=1,changed=2,deleted=3,xmlcreated=4,xmlchanged=5,xmldeleted=6)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# VERSION       change_user_id           LONG       User ID (editor)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# VERSION       deactivated              BOOLEAN    Deactivated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# VERSION       id                       LONG       ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# VERSION       substitute_user_id       LONG       User ID (substitute)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
# VERSION       version_active           BOOLEAN    Current version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
# VERSION       version_number           LONG       Version number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# TRANSACTIONAL execution_date           DATE       Processed on                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# TRANSACTIONAL owner                    LIST       Performed by                                        to 1 USER (LT=3312)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# TRANSACTIONAL owner_group              LIST       Owner group                                         to 1 USERGROUP (LT=3311)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# TRANSACTIONAL owner_status             ENUM       Owner status                                        lossdb_lossowner_state (all=-1,open=-2,new=1,in_progress=2,closed=3)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# TRANSACTIONAL owner_substitute         LIST       Performed by (substitute)                           to 1 USER (LT=3313)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# TRANSACTIONAL review_date              DATE       Review date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# TRANSACTIONAL reviewer                 LIST       Reviewer                                            to 1 USER (LT=4017)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# TRANSACTIONAL reviewer_group           LIST       Reviewer group                                      to 1 USERGROUP (LT=3314)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# TRANSACTIONAL reviewer_status          ENUM       Reviewer status                                     lossdb_lossreviewer_state (all=-1,unspecified=0,accepted=1,rejected=2,not_accepted=-3)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
# TRANSACTIONAL reviewer_substitute      LIST       Reviewer (substitute)                               to 1 USER (LT=4018)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
# LOSS          appsystem                LIST       Related application system types                    to * HIERARCHYs (LT=3319)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# LOSS            appsystem_grossActual  DOUBLE     Current loss per application system type (gross)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# LOSS            appsystem_netActual    DOUBLE     Current loss per application system type (net)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# LOSS          creditDefault            BOOLEAN    Credit default                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# LOSS          currency                 ENUM       Currency                                            currency (please_select=0,MIXED=-99,common=-1,AUD=8,CAD=26,CNY=30,EUR=47,GBP=50,JPY=74,USD=155,others=-2,AED=1,AFA=2,AFN=971,ALL=3,AMD=4,ANG=5,AOA=6,ARS=7,AWG=9,AZM=10,BAM=11,BBD=12,BDT=13,BGN=14,BHD=15,BIF=16,BMD=17,BND=18,BOB=19,BRL=20,BSD=21,BTN=22,BWP=23,BYR=24,BZD=25,CDF=27,CHF=28,CLP=29,COP=31,CRC=32,CSD=33,CUC=34,CUP=35,CVE=36,CYP=37,CZK=38,DJF=39,DKK=40,DOP=41,DZD=42,EEK=43,EGP=44,ERN=45,ETB=46,FJD=48,FKP=49,GEL=51,GGP=52,GHC=53,GIP=54,GMD=55,GNF=56,GTQ=57,GYD=58,HKD=59,HNL=60,HRK=61,HTG=62,HUF=63,IDR=64,ILS=65,IMP=66,INR=67,IQD=68,IRR=69,ISK=70,JEP=71,JMD=72,JOD=73,KES=75,KGS=76,KHR=77,KMF=78,KPW=79,KRW=80,KWD=81,KYD=82,KZT=83,LAK=84,LBP=85,LKR=86,LRD=87,LSL=88,LTL=89,LVL=90,LYD=91,MAD=92,MDL=93,MGA=94,MKD=95,MMK=96,MNT=97,MOP=98,MRO=99,MTL=100,MUR=101,MVR=102,MWK=103,MXN=104,MYR=105,MZM=106,MZN=943,NAD=107,NGN=108,NIO=109,NOK=110,NPR=111,NZD=112,OMR=113,PAB=114,PEN=115,PGK=116,PHP=117,PKR=118,PLN=119,PYG=120,QAR=121,ROL=122,RON=946,RSD=941,RUB=123,RWF=124,SAR=125,SBD=126,SCR=127,SDD=128,SDG=938,SEK=129,SGD=130,SHP=131,SIT=132,SKK=133,SLL=134,SOS=135,SPL=136,SRD=137,STD=138,SVC=139,SYP=140,SZL=141,THB=142,TJS=143,TMM=144,TND=145,TOP=146,TRL=147,TRY=148,TTD=149,TVD=150,TWD=151,TZS=152,UAH=153,UGX=154,UYU=156,UZS=157,VEB=158,VEF=937,VND=159,VUV=160,WST=161,XAF=162,XAG=163,XAU=164,XCD=165,XDR=166,XOF=167,XPD=168,XPF=169,XPT=170,YER=171,ZAR=172,ZMK=173,ZWD=174)
# LOSS          description              TEXT       Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# LOSS          discoveryDate            DATE       Discovery date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# LOSS          documents                LIST       Documents                                           to * DOCUMENTs (LT=3310)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# LOSS          entryDate                DATE       Occurrence date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
# LOSS          finaccount               LIST       Related regulations                                 to * HIERARCHYs (LT=3318)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# LOSS            finaccount_grossActual DOUBLE     Current loss regulations (gross)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# LOSS            finaccount_netActual   DOUBLE     Current loss per regulation (net)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# LOSS          grossTotalLoss           DOUBLE     Total loss (gross)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
# LOSS          incident                 LIST       Incident                                            to 1 INCIDENT (LT=3320)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# LOSS          insurancePayment         BOOLEAN    Insurance payment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# LOSS          lossReserves             DOUBLE     Reserves                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# LOSS          name                     STRING     Name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
# LOSS          netTotalLoss             DOUBLE     Total loss (net)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# LOSS          orgunit                  LIST       Related organizational units                        to * HIERARCHYs (LT=3317)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# LOSS            orgunit_grossActual    DOUBLE     Current loss per organizational unit (gross)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
# LOSS            orgunit_netActual      DOUBLE     Current loss per organizational unit (net)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
# LOSS          ownerRemark              TEXT       Remark (owner)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# LOSS          process                  LIST       Related processes                                   to * HIERARCHYs (LT=3316)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# LOSS            process_grossActual    DOUBLE     Current loss per process (gross)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# LOSS            process_netActual      DOUBLE     Current loss per process (net)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
# LOSS          relRisks                 LIST       Related risks                                       to * RISKs (LT=3315)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# LOSS            relRisks_grossActual   DOUBLE     Current loss per risk (gross)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
# LOSS            relRisks_netActual     DOUBLE     Current loss per risk (net)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
# LOSS          relevantForAppSysEval    BOOLEAN    Relevant for evaluation of application system types                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
# LOSS          relevantForFinAccEval    BOOLEAN    Relevant for evaluation of regulations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# LOSS          relevantForOrgUnitEval   BOOLEAN    Relevant for evaluation of organizational units                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
# LOSS          relevantForProcessEval   BOOLEAN    Relevant for evaluation of processes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
# LOSS          relevantForRiskEval      BOOLEAN    Relevant for evaluation of risks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
# LOSS          reviewerRemark           TEXT       Remark (reviewer)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
# LOSS          type                     ENUM       Loss type                                           lossdb_loss_type (all=-1,please_select=0,loss=-2,direct_loss=1,indirect_loss=2,near_loss=3,gain=4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          

# DO NOT CHANGE THE LINES ABOVE - all of them will be updated automatically by tool com.idsscheer.webapps.arcm.bl.re.RETemplater

################################################
### All workflow states - before state rules ###

rule " execution_date invisible [I,V]"

	salience 10500

	when

	then
		set "execution_date" invisible

end

rule "creditDefault, insurancePayment, and lossReserves visible [I,V]"

	salience 10400

	when
	    value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS NOT" value "direct_loss"
	    value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS NOT" value "indirect_loss"

	then
		set "creditDefault" invisible
		set "insurancePayment" invisible
		set "lossReserves" invisible

end

rule "process visible [I,V]"

	salience 10300

	when
	    value comparison fulfilled: ":transient:" attr_value "relevantForProcessEval" "EQUALS" value "false"

	then
	    set "process" invisible
	    set all "process" "process_netActual" invisible
	    set all "process" "process_grossActual" invisible
end

rule "orgunit visible [I,V]"

	salience 10200

	when
	    value comparison fulfilled: ":transient:" attr_value "relevantForOrgUnitEval" "EQUALS" value "false"

	then
	    set "orgunit" invisible
	    set all "orgunit" "orgunit_netActual" invisible
	    set all "orgunit" "orgunit_grossActual" invisible
end

rule "finaccount visible [I,V]"

	salience 10100

	when
	    value comparison fulfilled: ":transient:" attr_value "relevantForFinAccEval" "EQUALS" value "false"

	then
	    set "finaccount" invisible
	    set all "finaccount" "finaccount_netActual" invisible
	    set all "finaccount" "finaccount_grossActual" invisible
end

rule "appsystem visible [I,V]"

	salience 10000

	when
	    value comparison fulfilled: ":transient:" attr_value "relevantForAppSysEval" "EQUALS" value "false"

	then
	    set "appsystem" invisible
	    set all "appsystem" "appsystem_netActual" invisible
	    set all "appsystem" "appsystem_grossActual" invisible
end

##########################################################
### Workflow states "PREPARED" and "openForExecution"  ###

rule "editable attributes for manager [I,V]"

	salience 2600

	when
	    is in workflow state "openForExecution"
		user has at object role "lossmanager"

	then
		set "owner_group" editable
		set "reviewer_group" editable
		set "bb_URL" editable
end

rule "mandatory attributes for manager [I,V]"

	salience 2500

	when
        is in workflow state "openForExecution"
		user has at object role "lossmanager"

	then
		set "owner_group" mandatory
		set "reviewer_group" mandatory
		set "bb_URL" mandatory
end

rule "editable attributes for owner [I,V]"

	salience 2400

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened by the owner before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"

	then
		set "name" editable
		set "type" editable
		set "description" editable
		set "discoveryDate" editable
		set "entryDate" editable
		set "currency" editable
		set "creditDefault" editable
		set "incident" editable
		set "insurancePayment" editable
		set "lossReserves" editable
		set "grossTotalLoss" editable
		set "netTotalLoss" editable
		
		# BdB CUSTOMIZATION
		set "bb_saldo" editable
		
		set "documents" editable
		set "owner_status" editable
		set "ownerRemark" editable
		set "reviewer_group" editable
		set "bb_URL" editable

		# never editable:
		# set "relevantForRiskEval" editable

		set "relRisks" editable
		set all "relRisks" "relRisks_netActual" editable
		set all "relRisks" "relRisks_grossActual" editable

		set "process" editable
		set all "process" "process_netActual" editable
		set all "process" "process_grossActual" editable

		set "orgunit" editable
		set all "orgunit" "orgunit_netActual" editable
		set all "orgunit" "orgunit_grossActual" editable

		set "finaccount" editable
		set all "finaccount" "finaccount_netActual" editable
		set all "finaccount" "finaccount_grossActual" editable

		set "appsystem" editable
		set all "appsystem" "appsystem_netActual" editable
		set all "appsystem" "appsystem_grossActual" editable

end

rule "mandatory attributes for owner [I,V]"

	salience 2300

	when
        # we must also check for state "PREPARED" because a new loss's form can be opened by the owner before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"

	then
		set "name" mandatory
		set "type" mandatory
		set "description" mandatory
		set "discoveryDate" mandatory
		set "entryDate" mandatory
		set "currency" mandatory
		set "grossTotalLoss" mandatory
		set "netTotalLoss" mandatory
		
		# BdB CUSTOMIZATION
		set "bb_saldo" mandatory
		
		set "reviewer_group" mandatory
		#set "relevantForRiskEval" mandatory
		set "relevantForProcessEval" mandatory
		set "relevantForOrgUnitEval" mandatory
		set "relevantForFinAccEval" mandatory
		set "relevantForAppSysEval" mandatory
		set "bb_URL" mandatory

end

rule "process editable for owner [I,V]"

    salience 2200

    when
	    # we must also check for state "PREPARED" because a new loss's form can be opened by the owner before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "relevantForProcessEval" "EQUALS" value "false" OR
		  "process" is_not filled )
	then
	    set "relevantForProcessEval" editable

end

rule "orgunit editable for owner [I,V]"

    salience 2100

    when
	    # we must also check for state "PREPARED" because a new loss's form can be opened by the owner before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "relevantForOrgUnitEval" "EQUALS" value "false" OR
		  "orgunit" is_not filled )
	then
	    set "relevantForOrgUnitEval" editable

end

rule "finaccount editable for owner [I,V]"

    salience 2000

    when
	    # we must also check for state "PREPARED" because a new loss's form can be opened by the owner before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "relevantForFinAccEval" "EQUALS" value "false" OR
		  "finaccount" is_not filled )
	then
	    set "relevantForFinAccEval" editable

end

rule "appsystem editable for owner [I,V]"

    salience 1900

    when
	    # we must also check for state "PREPARED" because a new loss's form can be opened by the owner before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "relevantForAppSysEval" "EQUALS" value "false" OR
		  "appsystem" is_not filled )
	then
	    set "relevantForAppSysEval" editable

end

rule "risk related amounts mandatory [I,V]"

	salience 1800

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		value comparison fulfilled: ":transient:" attr_value "relevantForRiskEval" "EQUALS" value "true"

	then
		set all "relRisks" "relRisks_netActual"   mandatory
		set all "relRisks" "relRisks_grossActual" mandatory

end

rule "process hierarchy related amounts mandatory [I,V]"

	salience 1700

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		value comparison fulfilled: ":transient:" attr_value "relevantForProcessEval" "EQUALS" value "true"

	then
		set all "process" "process_netActual"   mandatory
		set all "process" "process_grossActual" mandatory

end

rule "organization hierarchy related amounts mandatory [I,V]"

	salience 1600

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		value comparison fulfilled: ":transient:" attr_value "relevantForOrgUnitEval" "EQUALS" value "true"

	then
		set all "orgunit" "orgunit_netActual"   mandatory
		set all "orgunit" "orgunit_grossActual" mandatory

end

rule "financial account hierarchy related amounts mandatory [I,V]"

	salience 1500

	when
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		value comparison fulfilled: ":transient:" attr_value "relevantForFinAccEval" "EQUALS" value "true"

	then
		set all "finaccount" "finaccount_netActual"   mandatory
		set all "finaccount" "finaccount_grossActual" mandatory

end

rule "application system type hierarchy related amounts mandatory [I,V]"

	salience 1400

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		value comparison fulfilled: ":transient:" attr_value "relevantForAppSysEval" "EQUALS" value "true"

	then
		set all "appsystem" "appsystem_netActual"   mandatory
		set all "appsystem" "appsystem_grossActual" mandatory

end

#
# Concept, Version 1.1.10, S.34:
# ------------------------------
# Exactly one Incident has to be assigned to a loss. As soon as no
# incident is assigned 'Save with status Closed' is not possible.
#
rule "incident mandatory attributes [I,V]"

	salience 1300
	
	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		value comparison fulfilled: ":transient:" attr_value "owner_status" "CONTAINS" value "closed"

	then
		set "incident" mandatory
		set "relRisks" mandatory

end

#
# lossFlag mandatory (rule drawn from concept)
# <If <Loss Flag> = <Indirect Loss> or <Loss Flag> = <Direct Loss>
# Then
# 	<Loss entry date> is mandatory
# 	<Credit default> is visible and mandatory
# 	<Insurance payment> is visible and mandatory
# 	If <Insurance payment> is "Yes"
# 	Then
# 		<Loss reserves> is mandatory
# 	End
# End>
#
rule "mandatory because of lossFlag - part I [I,V]"

	salience 1200

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS" value "direct_loss" OR
		  value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS" value "indirect_loss" )

	then
		set "creditDefault" mandatory
		set "insurancePayment" mandatory

end

rule "mandatory because of lossFlag - part II [I,V]"

	salience 1100

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS" value "direct_loss" OR
		  value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS" value "indirect_loss" )
		value comparison fulfilled: ":transient:" attr_value "insurancePayment" "EQUALS" value "true"

	then
		set "lossReserves" mandatory

end

rule "lossReserves>0 only if mandatory [I,V]"

	salience 1000

	when
	    # we must also check for state "PREPARED" because a new loss's form can be opened before saving
	    ( is in workflow state "openForExecution" OR
		  is in workflow state "PREPARED" )
		user is ":transient:" member of group in list "owner_group"
		( value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS" value "direct_loss" OR
		  value comparison fulfilled: ":transient:" attr_value "type" "CONTAINS" value "indirect_loss" )
		value comparison fulfilled: ":transient:" attr_value "insurancePayment" "EQUALS" value "true"
		value comparison fulfilled: ":transient:" attr_value "lossReserves" "LESS EQUAL" value ":ZERO:"

	then
		set "lossReserves" invalid
		add "error" message "value.must.be.positive.ERR" to "lossReserves"

end

#######################################
### Workflow state "openForReview"  ###

rule "editable attributes for reviewer [I,V]"

	salience 1100

	when
		is in workflow state "openForReview"
		user is ":transient:" member of group in list "reviewer_group"

	then
		set "reviewer_status" editable
		set "reviewerRemark" editable

end

rule "reviewer remark mandatory [I,V]"

	salience 1000

	when
	    is in workflow state "openForReview"
		user is ":transient:" member of group in list "reviewer_group"
		value comparison fulfilled: ":transient:" attr_value "reviewer_status" "CONTAINS" value "rejected"

	then
		set "reviewerRemark" mandatory

end

###############################################
### All workflow states - after state rules ###

#
# The format for:
#
# <Loss reserves, Gross total loss, Net total Loss, Gross actual loss per xxx, Net actual loss per xxx>
# are unsigned several integer parts but only 2 decimal parts.
# The attribute <gross total loss> has to be >=  <net total loss>. This rule is also valid for
# the attributes <gross actual loss per xxx> and <net actual loss per xxx>.
# If the total gross or net loss value will change after distribution, the system has to check first:
# Gross total loss >= Net total loss
#
# Second:
#
# Gross actual loss per xxx >= Net actual loss per xxx
# Sum of gross actual loss per xxx <= Gross total loss
# Sum of net actual loss per xxx <= Net total loss
#
# Third:
#
# The sum of the net values related to all defined risks and validates whether this sum is at most as much as the net
# value defined for this loss. The same applies for the gross value.
# Net and gross value sums over the related organizational, financial account, process, and application system types
# hierarchies are validated in the same way.
rule "validate amounts [I,V]"

	salience 100

	when

	then
		validate custom amounts

end
